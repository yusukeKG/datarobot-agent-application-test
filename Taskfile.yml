---
version: '3'
env:
  ENV: testing
dotenv: ['.env', '.env.{{.ENV}}']
includes:
  core:
    taskfile: ./core/Taskfile.yaml
    dir: ./core
  frontend_web:
    taskfile: ./frontend_web/Taskfile.yaml
    dir: ./frontend_web
  infra:
    taskfile: ./infra/Taskfile.yaml
    dir: ./infra
  mcp_server:
    taskfile: ./mcp_server/Taskfile.yaml
    dir: ./mcp_server
  tests:
    taskfile: ./tests/Taskfile.yaml
    dir: ./tests
  web:
    taskfile: ./web/Taskfile.yaml
    dir: ./web
  writer_agent:
    taskfile: ./writer_agent/Taskfile.yml
    dir: ./writer_agent
tasks:
  default:
    desc: "â„¹ï¸ Show all available tasks (run `task --list-all` to see hidden tasks)"
    cmds:
      - task --list --sort none
    silent: true

  start:
    desc: "ğŸ’» Prepare local development environment"
    cmds:
      - dr dotenv setup --if-needed
      - task: install
      # These need to be task <command> so that the .env vars are loaded properly
      # - task infra:start  # This adds a lot of startup time
      - task web:start

  lint:
    desc: "ğŸ§¹ Run linters"
    cmds:
      - task: core:lint
      - task: frontend_web:lint
      - task: infra:lint
      - task: mcp_server:lint
      - task: tests:lint
      - task: web:lint

  install:
    desc: "ğŸ› ï¸ Install all dependencies"
    cmds:
      - task: core:install
      - task: frontend_web:install
      - task: infra:install
      - task: mcp_server:install
      - task: tests:install
      - task: web:install
      - task: writer_agent:install

  test:
    desc: "ğŸ§ª Run tests across all components"
    cmds:
      - task: core:test
      - task: frontend_web:test
      - task: mcp_server:test
      - task: tests:test
      - task: web:test
  dev:
    desc: "ğŸš€ Run all services together"
    cmds:
      - |
        task frontend_web:dev &
        sleep 3
        task mcp_server:dev &
        sleep 3
        task web:dev &
        sleep 3
        task writer_agent:dev &
        sleep 8
        echo "âœ… All servers started!"
        if [[ -n "$NOTEBOOK_ID" ]]; then
          prefix="${DATAROBOT_API_ENDPOINT//api\/v2/}notebook-sessions/$NOTEBOOK_ID/ports/"
        else
          prefix="http://localhost:"
        fi
        echo "ğŸ”— Backend: ${prefix}8080"
        echo "ğŸ”— Frontend: ${prefix}5173"
        echo "ğŸ”— Agent: ${prefix}8842"
        echo "ğŸ”— MCP Server: ${prefix}9000"
        wait
  deploy:
    desc: "ğŸš€ Deploy all services"
    env:
      AGENT_DEPLOY: "1"
    cmds:
      - task: infra:deploy
  deploy-dev:
    desc: "ğŸš€ Deploy infrastructure and services to development"
    cmds:
      - task: infra:deploy-dev
