---
# https://taskfile.dev
version: '3'
tasks:
  install-pulumi-plugin:
    # Prevents github rate limiting issues when installing pulumi datarobot plugin.
    # See https://github.com/datarobot-community/pulumi-datarobot?tab=readme-ov-file#rate-limited-by-github
    silent: true
    # desc: "â¬‡ï¸ Install DataRobot Pulumi plugins"
    cmds:
      - uv run pulumi plugin install resource datarobot v0.10.23 --server https://github.com/datarobot-community/pulumi-datarobot/releases/download/v0.10.23/

  auth-check:
    silent: true
    desc: "ğŸ” Check authentication prerequisites"
    cmds:
      - |
        if command -v dr &> /dev/null && dr auth help 2>&1 | grep -q "check"; then
          echo "ğŸ” Checking authentication.."
          dr auth check
        else
          echo "â„¹ï¸  Skipping auth check (not available)"
        fi

  install:
    desc: "ğŸ”§ Install dependencies"
    cmds:
      - echo "ğŸ”§ Installing dependencies.."
      - uv sync --all-extras --dev

  start:
    silent: true
    desc: "ğŸ’» Deploy backing infrastructure"
    deps:
      - auth-check
    cmds:
      - task: deploy-dev

  lint:
    silent: true
    desc: "ğŸ§¹ Run linters"
    cmds:
      - echo "ğŸ§¹ Running linters.."
      - uv run ruff format .
      - uv run ruff check . --fix
      - uv run mypy --pretty .

  lint-check:
    silent: true
    desc: "ğŸ§¹ Check whether the codebase is linted"
    cmds:
      - uv run ruff format --check .
      - uv run ruff check .
      - uv run mypy --pretty .

  init:
    silent: true
    desc: "ğŸ†• Initialize a new Pulumi stack"
    cmds:
      - uv run pulumi stack init

  select:
    silent: true
    desc: "ğŸš‚ Select a Stack"
    cmds:
      - uv run pulumi stack select

  up:
    silent: true
    aliases:
      - deploy
    desc: "ğŸ”¨ Deploy the infrastructure"
    deps:
      - auth-check
    cmds:
      - task: install-pulumi-plugin
      - echo "ğŸ”¨ Deploying the infrastructure.."
      - export PULUMI_SKIP_UPDATE_CHECK=1 && uv run pulumi up

  info:
    silent: true
    desc: "â„¹ï¸ Show Pulumi stack info"
    cmds:
      - task: install-pulumi-plugin
      - export PULUMI_SKIP_UPDATE_CHECK=1 && uv run pulumi stack

  down:
    silent: true
    aliases:
      - destroy
    desc: "ğŸ’¥ Destroy the deployed infrastructure"
    deps:
      - auth-check
    cmds:
      - task: install-pulumi-plugin
      - echo "ğŸ’¥ Destroying the infrastructure.."
      - export PULUMI_SKIP_UPDATE_CHECK=1 && uv run pulumi down

  copyright:
    aliases:
      - license
    desc: ğŸ“œ Apply license headers
    cmds:
      - echo "ğŸ“œ Applying license headers"
      - docker run  --rm -v $PWD:/github/workspace ghcr.io/apache/skywalking-eyes/license-eye:eb0e0b091ea41213f712f622797e37526ca1e5d6
        -v info -c .licenserc.yaml header fix

  copyright-check:
    aliases:
      - license-check
    desc: ğŸ“œ Checking for license headers
    cmds:
      - echo "ğŸ“œ Checking license headers"
      - docker run  --rm -v $PWD:/github/workspace ghcr.io/apache/skywalking-eyes/license-eye:eb0e0b091ea41213f712f622797e37526ca1e5d6
        -v info -c .licenserc.yaml header check

  deploy-dev:
    silent: true
    aliases: [up-dev]
    desc: "ğŸ”¨ Deploy the backend infrastructure"
    cmds:
      - task: install-pulumi-plugin
      - echo "ğŸ”¨ Deploying the backend infrastructure.."
      - |
        export PULUMI_SKIP_UPDATE_CHECK=1 && uv run pulumi up -y \
          --target 'urn:pulumi:*::agentic-writer::datarobot:index/deployment:Deployment::*LLM Blueprint Deployment*' \
          --target 'urn:pulumi:*::agentic-writer::datarobot:index/predictionEnvironment:PredictionEnvironment::*' \
          --target 'urn:pulumi:*::agentic-writer::datarobot:index/useCase:UseCase::*' \
          --target 'urn:pulumi:*::agentic-writer::datarobot:index/customModel:CustomModel::*LLM Blueprint Model*' \
          --target 'urn:pulumi:*::agentic-writer::datarobot:index/apiTokenCredential:ApiTokenCredential::*' \
          --target 'urn:pulumi:*::agentic-writer::datarobot:index/llmBlueprint:LlmBlueprint::]' \
          --target 'urn:pulumi:*::agentic-writer::datarobot:index/appOauth:AppOauth::'
